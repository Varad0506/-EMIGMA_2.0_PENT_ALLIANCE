<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroPulse AI | Biological Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: #f8fafc; min-height: 100vh; font-size: 20px; overflow-x: hidden; }
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.1); }
        .input-field { background: #111827; border: 2px solid #3b82f6; border-radius: 16px; padding: 20px; width: 100%; outline: none; color: white; font-size: 20px; }
        .condition-card { cursor: pointer; transition: all 0.3s ease; border: 2px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); text-align: center; }
        .condition-card.active { border-color: #3b82f6; background: rgba(59, 130, 246, 0.2); transform: scale(1.02); }
        .result-glow { text-shadow: 0 0 40px rgba(59, 130, 246, 0.8); }
        .reason-card { background: rgba(59, 130, 246, 0.15); border-left: 8px solid #3b82f6; padding: 24px; border-radius: 0 24px 24px 0; margin-bottom: 20px; font-size: 22px; }
        .predict-card { background: rgba(16, 185, 129, 0.1); border-left: 8px solid #10b981; padding: 20px; border-radius: 0 24px 24px 0; margin-bottom: 15px; }
        
        #history-panel { transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        #history-panel.open { transform: translateX(0); }
        .breath-orb { width: 100px; height: 100px; border-radius: 50%; background: radial-gradient(circle, #3b82f6 0%, transparent 70%); margin: 20px auto; transition: transform 4s ease-in-out; }
        .inhale { transform: scale(1.8); }
        .exhale { transform: scale(1.0); }
    </style>
</head>
<body class="p-6 md:p-12">

    <div id="history-panel" class="fixed top-0 right-0 w-full md:w-96 h-full glass z-[1000] p-8 overflow-y-auto border-l border-white/10 shadow-2xl">
        <div class="flex justify-between items-center mb-10">
            <h2 class="text-3xl font-black uppercase italic">Analysis <span class="text-blue-500">Log</span></h2>
            <button onclick="toggleHistory()" class="p-2 hover:bg-white/10 rounded-full"><i data-lucide="x"></i></button>
        </div>
        <div id="history-list"></div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-10">
        <div class="lg:col-span-5 space-y-8">
            <div class="flex justify-between items-center">
                <button onclick="window.location.href='index.html'" class="text-blue-400 font-bold flex items-center gap-2 text-2xl"><i data-lucide="arrow-left"></i> Back</button>
                <button onclick="toggleHistory()" class="bg-white/5 border border-white/10 px-6 py-3 rounded-2xl flex items-center gap-3 font-bold">History</button>
            </div>

            <div class="glass p-8 rounded-[3rem] border-l-8 border-emerald-500">
                <h2 class="text-2xl font-black uppercase italic mb-4 text-emerald-400">Recovery Mode</h2>
                <div id="breath-setup" class="grid grid-cols-4 gap-2 mb-4">
                    <button onclick="startBreathing(2)" class="bg-white/5 p-2 rounded-xl text-sm font-bold">2m</button>
                    <button onclick="startBreathing(3)" class="bg-white/5 p-2 rounded-xl text-sm font-bold">3m</button>
                    <button onclick="startBreathing(4)" class="bg-white/5 p-2 rounded-xl text-sm font-bold">4m</button>
                    <button onclick="startBreathing(5)" class="bg-white/5 p-2 rounded-xl text-sm font-bold">5m</button>
                </div>
                <div id="breath-player" class="hidden text-center">
                    <div id="orb" class="breath-orb exhale"></div>
                    <p id="breath-status" class="text-xl font-bold text-emerald-400 uppercase">Ready</p>
                    <p id="timer-display" class="text-3xl font-mono text-white/50">00:00</p>
                    <button onclick="stopBreathing()" class="mt-4 text-xs text-red-400 font-black">STOP</button>
                </div>
            </div>
            
            <div class="glass p-10 rounded-[3rem] space-y-8">
                <h1 class="text-5xl font-black italic uppercase">Body <span class="text-blue-500">Stats</span></h1>
                <input type="number" id="user-age" placeholder="Age" value="25" class="input-field">
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="user-height" placeholder="Height cm" value="170" class="input-field">
                    <input type="number" id="user-weight" placeholder="Weight kg" value="70" class="input-field">
                </div>
                <div class="grid grid-cols-1 gap-3">
                    <div onclick="setCondition('Healthy', 1.0)" id="card-Healthy" class="condition-card p-6 rounded-2xl active uppercase font-black">Healthy</div>
                    <div onclick="setCondition('Asthma', 2.5)" id="card-Asthma" class="condition-card p-6 rounded-2xl uppercase font-black">Asthma</div>
                    <div onclick="setCondition('COPD', 4.0)" id="card-COPD" class="condition-card p-6 rounded-2xl uppercase font-black">COPD</div>
                </div>
                <div id="duration-section" class="hidden"><input type="number" id="disease-years" value="1" class="input-field" placeholder="Years active"></div>
                <button onclick="calculateDeepRisk()" class="w-full bg-blue-600 py-6 rounded-3xl font-black uppercase text-2xl shadow-2xl">Run AI Analysis</button>
            </div>
        </div>

        <div class="lg:col-span-7 space-y-8">
            <div id="result-view" class="hidden space-y-8">
                <div class="glass p-10 rounded-[4rem] border-b-8 border-blue-500/20 text-center">
                    <p class="text-xl font-bold text-slate-400 uppercase">Lung Age</p>
                    <p id="disp-lung" class="text-9xl font-black italic text-white result-glow leading-none my-6">--</p>
                </div>
                <div class="glass p-10 rounded-[3rem]">
                    <h2 class="text-3xl font-black uppercase italic text-blue-400 mb-6">Why this result?</h2>
                    <div id="reasons-container" class="space-y-4"></div>
                    
                    <h2 class="text-3xl font-black uppercase italic text-emerald-400 mt-10 mb-6">3-Week Prediction</h2>
                    <div id="prediction-container" class="space-y-4"></div>
                </div>
                <div class="glass p-10 rounded-[3rem]"><div class="h-64"><canvas id="trendChart"></canvas></div></div>
            </div>
            <div id="empty-state" class="h-full flex flex-col items-center justify-center opacity-20">
                <i data-lucide="heart-pulse" class="w-40 h-40"></i>
                <p class="text-3xl font-black uppercase">Awaiting Stats</p>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        let currentStatus = 'Healthy', mult = 1.0, chartInstance = null;
        let breathInterval, timerInterval;

        // --- SMOOTH WIND SOUND ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBreathSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const noise = audioCtx.createBufferSource();
            const bufferSize = audioCtx.sampleRate * 4;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            noise.buffer = buffer;

            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            const gain = audioCtx.createGain();

            if (type === 'inhale') {
                filter.frequency.setValueAtTime(200, audioCtx.currentTime);
                filter.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 3.5);
                gain.gain.setValueAtTime(0, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0.1, audioCtx.currentTime + 1);
            } else {
                filter.frequency.setValueAtTime(1000, audioCtx.currentTime);
                filter.frequency.exponentialRampToValueAtTime(200, audioCtx.currentTime + 3.5);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 3.5);
            }

            noise.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination);
            noise.start(); noise.stop(audioCtx.currentTime + 4);
        }

        function startBreathing(mins) {
            document.getElementById('breath-setup').classList.add('hidden');
            document.getElementById('breath-player').classList.remove('hidden');
            let timeLeft = mins * 60, cycle = 0;
            const update = () => {
                const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
                document.getElementById('timer-display').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
                if (timeLeft-- <= 0) stopBreathing();
            };
            const animate = () => {
                const orb = document.getElementById('orb'), status = document.getElementById('breath-status');
                if (cycle === 0) {
                    orb.classList.replace('exhale', 'inhale'); status.innerText = "Inhale...";
                    playBreathSound('inhale'); cycle = 1;
                } else {
                    orb.classList.replace('inhale', 'exhale'); status.innerText = "Exhale...";
                    playBreathSound('exhale'); cycle = 0;
                }
            };
            update(); animate();
            timerInterval = setInterval(update, 1000);
            breathInterval = setInterval(animate, 4000);
        }

        function stopBreathing() { clearInterval(timerInterval); clearInterval(breathInterval); 
            document.getElementById('breath-setup').classList.remove('hidden'); document.getElementById('breath-player').classList.add('hidden'); }

        function setCondition(name, val) {
            currentStatus = name; mult = val;
            document.querySelectorAll('.condition-card').forEach(c => c.classList.remove('active'));
            document.getElementById('card-' + name).classList.add('active');
            document.getElementById('duration-section').classList.toggle('hidden', name === 'Healthy');
        }

        function calculateDeepRisk() {
            const air = JSON.parse(localStorage.getItem('currentAirData') || '{"aqi":50}');
            const age = parseInt(document.getElementById('user-age').value);
            const bmi = parseInt(document.getElementById('user-weight').value) / (Math.pow(parseInt(document.getElementById('user-height').value)/100, 2));
            const y = parseInt(document.getElementById('disease-years').value) || 0;
            
            let lungAge = Math.round(age + (bmi > 26 ? (bmi-26)*1.5 : 0) + (y * 1.2) + (mult * 5) + (air.aqi / 20));

            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('result-view').classList.remove('hidden');
            document.getElementById('disp-lung').innerText = lungAge;

            // Reasons Explanation
            document.getElementById('reasons-container').innerHTML = `
                <div class="reason-card">ðŸ’¨ <b>Pollution:</b> AQI ${air.aqi} is currently increasing your lung stress.</div>
                <div class="reason-card">ðŸ§¬ <b>Biology:</b> Your ${currentStatus} profile is being factored into elasticity levels.</div>
            `;

            // 3-WEEK PREDICTION LOGIC
            document.getElementById('prediction-container').innerHTML = `
                <div class="predict-card"><b>Week 1:</b> Diaphragm strengthening will lower Stress Score volatility.</div>
                <div class="predict-card"><b>Week 2:</b> Increased Alveolar efficiency will likely reduce Lung Age by 1.2 years.</div>
                <div class="predict-card"><b>Week 3:</b> Nervous system integration will stabilize resting breath rate.</div>
            `;

            renderTrend(air.aqi * mult);
        }

        function toggleHistory() { document.getElementById('history-panel').classList.toggle('open'); }
        
        function renderTrend(base) {
            const ctx = document.getElementById('trendChart');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: ['W1', 'W2', 'W3'], datasets: [{ data: [base, base*1.1, base*0.8], borderColor: '#3b82f6', fill: true, backgroundColor: 'rgba(59, 130, 246, 0.1)' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }
    </script>
</body>
</html>
