<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroPulse AI | Biological Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: #f8fafc; min-height: 100vh; font-size: 20px; overflow-x: hidden; }
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.1); }
        .input-field { background: #111827; border: 2px solid #3b82f6; border-radius: 16px; padding: 20px; width: 100%; outline: none; color: white; font-size: 20px; }
        .condition-card { cursor: pointer; transition: all 0.3s ease; border: 2px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); text-align: center; }
        .condition-card.active { border-color: #3b82f6; background: rgba(59, 130, 246, 0.2); transform: scale(1.02); }
        .result-glow { text-shadow: 0 0 40px rgba(59, 130, 246, 0.8); }
        .reason-card { background: rgba(59, 130, 246, 0.15); border-left: 8px solid #3b82f6; padding: 24px; border-radius: 0 24px 24px 0; margin-bottom: 20px; font-size: 22px; }
        
        /* History Sidebar */
        #history-panel { transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        #history-panel.open { transform: translateX(0); }
        .history-item { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 15px; margin-bottom: 12px; }

        /* Breathing Animation */
        .breath-orb { 
            width: 100px; height: 100px; border-radius: 50%; 
            background: radial-gradient(circle, #3b82f6 0%, transparent 70%); 
            margin: 20px auto; transition: transform 4s ease-in-out; 
        }
        .inhale { transform: scale(1.8); }
        .exhale { transform: scale(1.0); }
    </style>
</head>
<body class="p-6 md:p-12">

    <div id="history-panel" class="fixed top-0 right-0 w-full md:w-96 h-full glass z-[1000] p-8 overflow-y-auto border-l border-white/10 shadow-2xl">
        <div class="flex justify-between items-center mb-10">
            <h2 class="text-3xl font-black uppercase italic">Analysis <span class="text-blue-500">Log</span></h2>
            <button onclick="toggleHistory()" class="p-2 hover:bg-white/10 rounded-full"><i data-lucide="x"></i></button>
        </div>
        <div id="history-list"></div>
        <button onclick="clearHistory()" class="w-full mt-6 text-red-400 text-sm font-bold uppercase tracking-widest opacity-50 hover:opacity-100">Clear All Records</button>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-10">
        
        <div class="lg:col-span-5 space-y-8">
            <div class="flex justify-between items-center">
                <button onclick="window.location.href='index.html'" class="text-blue-400 font-bold flex items-center gap-2 text-2xl">
                    <i data-lucide="arrow-left" class="w-8 h-8"></i> Back
                </button>
                <button onclick="toggleHistory()" class="bg-white/5 border border-white/10 px-6 py-3 rounded-2xl flex items-center gap-3 font-bold hover:bg-white/10 transition-all">
                    <i data-lucide="history" class="w-6 h-6"></i> View History
                </button>
            </div>

            <div class="glass p-8 rounded-[3rem] border-l-8 border-emerald-500">
                <h2 class="text-2xl font-black uppercase italic mb-4 flex items-center gap-3">
                    <i data-lucide="wind" class="text-emerald-400"></i> Lung Recovery
                </h2>
                
                <div id="breath-setup" class="grid grid-cols-4 gap-2 mb-4">
                    <button onclick="startBreathing(2)" class="bg-white/5 p-2 rounded-xl text-sm font-bold hover:bg-emerald-500/20">2m</button>
                    <button onclick="startBreathing(3)" class="bg-white/5 p-2 rounded-xl text-sm font-bold hover:bg-emerald-500/20">3m</button>
                    <button onclick="startBreathing(4)" class="bg-white/5 p-2 rounded-xl text-sm font-bold hover:bg-emerald-500/20">4m</button>
                    <button onclick="startBreathing(5)" class="bg-white/5 p-2 rounded-xl text-sm font-bold hover:bg-emerald-500/20">5m</button>
                </div>

                <div id="breath-player" class="hidden text-center">
                    <div id="orb" class="breath-orb exhale"></div>
                    <p id="breath-status" class="text-xl font-bold text-emerald-400 uppercase tracking-widest mt-2">Get Ready</p>
                    <p id="timer-display" class="text-3xl font-mono mt-2 text-white/50">00:00</p>
                    <button onclick="stopBreathing()" class="mt-4 text-xs uppercase text-red-400 font-black">End Session</button>
                </div>
            </div>
            
            <div class="glass p-10 rounded-[3rem] space-y-8">
                <h1 class="text-5xl font-black italic uppercase">Body <span class="text-blue-500">Stats</span></h1>
                <div class="space-y-4">
                    <label class="font-bold text-slate-300">Your Age</label>
                    <input type="number" id="user-age" value="25" class="input-field">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="font-bold text-slate-300">Height (cm)</label>
                        <input type="number" id="user-height" value="170" class="input-field">
                    </div>
                    <div class="space-y-2">
                        <label class="font-bold text-slate-300">Weight (kg)</label>
                        <input type="number" id="user-weight" value="70" class="input-field">
                    </div>
                </div>
                <div class="space-y-4">
                    <label class="text-2xl font-bold text-blue-400">Lung Condition:</label>
                    <div class="grid grid-cols-1 gap-3">
                        <div onclick="setCondition('Healthy', 1.0)" id="card-Healthy" class="condition-card p-6 rounded-2xl active font-black uppercase">Healthy</div>
                        <div onclick="setCondition('Asthma', 2.5)" id="card-Asthma" class="condition-card p-6 rounded-2xl font-black uppercase">Asthma</div>
                        <div onclick="setCondition('COPD', 4.0)" id="card-COPD" class="condition-card p-6 rounded-2xl font-black uppercase">COPD / Bronchitis</div>
                    </div>
                </div>
                <div id="duration-section" class="hidden space-y-4">
                    <label class="text-xl font-bold text-orange-400 italic">Years with Condition?</label>
                    <input type="number" id="disease-years" value="1" class="input-field">
                </div>
                <button onclick="calculateDeepRisk()" class="w-full bg-blue-600 py-6 rounded-3xl font-black uppercase text-2xl shadow-2xl hover:bg-blue-500 transition-all">
                    Show Analysis
                </button>
            </div>
        </div>

        <div class="lg:col-span-7 space-y-8">
            <div id="result-view" class="hidden animate-in fade-in duration-1000 space-y-8">
                <div class="glass p-10 rounded-[4rem] border-b-8 border-blue-500/20 text-center">
                    <p class="text-xl font-bold text-slate-400 uppercase tracking-widest">Your Lung Age</p>
                    <p id="disp-lung" class="text-9xl font-black italic text-white result-glow leading-none my-6">--</p>
                </div>
                <div class="glass p-10 rounded-[3rem] border border-white/10">
                    <h2 class="text-3xl font-black uppercase italic text-blue-400 mb-6 flex items-center gap-3">
                        <i data-lucide="help-circle"></i> Why this result?
                    </h2>
                    <div id="reasons-container" class="space-y-4"></div>
                </div>
                <div class="glass p-10 rounded-[3rem]"><div class="h-64"><canvas id="trendChart"></canvas></div></div>
            </div>
            <div id="empty-state" class="h-full flex flex-col items-center justify-center opacity-20">
                <i data-lucide="heart-pulse" class="w-40 h-40 mb-6"></i>
                <p class="text-3xl font-black uppercase tracking-widest">Awaiting Stats</p>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        let currentStatus = 'Healthy', mult = 1.0, chartInstance = null;
        let breathInterval, timerInterval;

        // BREATHING EXERCISE LOGIC
        function startBreathing(mins) {
            document.getElementById('breath-setup').classList.add('hidden');
            document.getElementById('breath-player').classList.remove('hidden');
            
            let timeLeft = mins * 60;
            let cycle = 0; // 0 inhale, 1 exhale

            const updateTimer = () => {
                const m = Math.floor(timeLeft / 60);
                const s = timeLeft % 60;
                document.getElementById('timer-display').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
                if (timeLeft <= 0) stopBreathing();
                timeLeft--;
            };

            const animateCycle = () => {
                const orb = document.getElementById('orb');
                const status = document.getElementById('breath-status');
                if (cycle === 0) {
                    orb.classList.replace('exhale', 'inhale');
                    status.innerText = "Breathe In";
                    cycle = 1;
                } else {
                    orb.classList.replace('inhale', 'exhale');
                    status.innerText = "Breathe Out";
                    cycle = 0;
                }
            };

            updateTimer();
            animateCycle();
            timerInterval = setInterval(updateTimer, 1000);
            breathInterval = setInterval(animateCycle, 4000);
        }

        function stopBreathing() {
            clearInterval(timerInterval);
            clearInterval(breathInterval);
            document.getElementById('breath-setup').classList.remove('hidden');
            document.getElementById('breath-player').classList.add('hidden');
        }

        // ORIGINAL LOGIC
        function toggleHistory() { document.getElementById('history-panel').classList.toggle('open'); loadHistory(); }

        function setCondition(name, val) {
            currentStatus = name; mult = val;
            document.querySelectorAll('.condition-card').forEach(c => c.classList.remove('active'));
            document.getElementById('card-' + name).classList.add('active');
            document.getElementById('duration-section').style.display = (name === 'Healthy') ? 'none' : 'block';
        }

        function calculateDeepRisk() {
            const air = JSON.parse(localStorage.getItem('currentAirData') || '{"aqi":50}');
            const age = parseInt(document.getElementById('user-age').value);
            const height = parseInt(document.getElementById('user-height').value) / 100;
            const weight = parseInt(document.getElementById('user-weight').value);
            const years = currentStatus === 'Healthy' ? 0 : parseInt(document.getElementById('disease-years').value);

            const bmi = weight / (height * height);
            let bmiPenalty = bmi > 27 ? (bmi - 27) * 0.8 : 0;
            let finalLungAge = Math.round(age + bmiPenalty + (years * 0.9) + (mult * 4) + (air.aqi / 20));

            const history = JSON.parse(localStorage.getItem('lungHistory') || '[]');
            history.unshift({ age: finalLungAge, date: new Date().toLocaleTimeString(), condition: currentStatus });
            localStorage.setItem('lungHistory', JSON.stringify(history.slice(0, 10)));

            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('result-view').classList.remove('hidden');
            document.getElementById('disp-lung').innerText = finalLungAge;
            
            let reasons = [];
            if (air.aqi > 50) reasons.push(`üí® <b>Air Pollution:</b> The AQI level (${air.aqi}) is placing significant stress on your lung tissue.`);
            if (currentStatus !== 'Healthy') reasons.push(`üè• <b>Condition Wear:</b> ${years} years of ${currentStatus} has affected bronchial elasticity.`);
            if (bmi > 27) reasons.push(`‚öñÔ∏è <b>Physical Load:</b> Elevated BMI creates physical resistance against diaphragm expansion.`);
            
            document.getElementById('reasons-container').innerHTML = reasons.map(r => `<div class="reason-card">${r}</div>`).join('');
            
            const baseStress = air.aqi * mult;
            renderTrend(baseStress);
            lucide.createIcons();
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('lungHistory') || '[]');
            const list = document.getElementById('history-list');
            list.innerHTML = history.length ? history.map(h => `
                <div class="history-item">
                    <div class="flex justify-between items-center">
                        <span class="text-blue-400 font-black text-2xl">${h.age} yrs</span>
                        <span class="text-[10px] text-slate-500 font-bold uppercase">${h.date}</span>
                    </div>
                    <p class="text-xs text-slate-400 mt-1 uppercase tracking-widest">${h.condition} Profile</p>
                </div>
            `).join('') : '<p class="text-center opacity-30 mt-10">No records found</p>';
        }

        function clearHistory() { localStorage.removeItem('lungHistory'); loadHistory(); }

        function renderTrend(base) {
            const ctx = document.getElementById('trendChart');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3'],
                    datasets: [{
                        data: [base, base * 1.3, base * 0.85],
                        borderColor: '#3b82f6', borderWidth: 8, tension: 0.4, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.1)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, 
                scales: { y: { display: false }, x: { ticks: { color: '#94a3b8', font: { weight: 'bold' } }, grid: { display: false } } } }
            });
        }
    </script>
</body>
</html>
