<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroPulse AI | Clinical Diagnostic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #010409; color: #f8fafc; min-height: 100vh; }
        .glass { background: rgba(13, 17, 23, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.05); }
        .input-field { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; width: 100%; outline: none; transition: 0.3s; color: white; }
        .toggle-card { cursor: pointer; transition: 0.3s; border: 1px solid rgba(255,255,255,0.05); }
        .toggle-card.active { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .ai-border { position: relative; border-radius: 40px; padding: 2px; background: linear-gradient(45deg, #3b82f6, #10b981, #6366f1); background-size: 200% 200%; animation: gradient 5s ease infinite; }
        @keyframes gradient { 0% {background-position: 0% 50%;} 50% {background-position: 100% 50%;} 100% {background-position: 0% 50%;} }
    </style>
</head>
<body class="p-4 lg:p-10">

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div class="lg:col-span-5 space-y-6">
            <button onclick="window.location.href='index_new.html'" class="text-slate-500 hover:text-white text-[10px] font-black uppercase tracking-[0.2em] flex items-center gap-2 mb-4">
                <i data-lucide="arrow-left" class="w-3 h-3"></i> Back to Map
            </button>
            <div class="glass p-8 rounded-[2.5rem] space-y-6">
                <div class="grid grid-cols-3 gap-3">
                    <button onclick="setCondition('Healthy')" id="btn-Healthy" class="toggle-card active p-4 rounded-xl text-center"><span class="text-[8px] font-black uppercase">Healthy</span></button>
                    <button onclick="setCondition('Asthma')" id="btn-Asthma" class="toggle-card p-4 rounded-xl text-center"><span class="text-[8px] font-black uppercase">Asthma</span></button>
                    <button onclick="setCondition('COPD')" id="btn-COPD" class="toggle-card p-4 rounded-xl text-center"><span class="text-[8px] font-black uppercase">COPD</span></button>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button onclick="toggleLifestyle('smoke')" id="life-smoke" class="toggle-card p-4 rounded-xl flex justify-between">
                        <span class="text-[9px] font-black uppercase">Smoker</span>
                        <div id="check-smoke" class="w-2 h-2 rounded-full bg-slate-700"></div>
                    </button>
                    <button onclick="toggleLifestyle('drink')" id="life-drink" class="toggle-card p-4 rounded-xl flex justify-between">
                        <span class="text-[9px] font-black uppercase">Alcohol</span>
                        <div id="check-drink" class="w-2 h-2 rounded-full bg-slate-700"></div>
                    </button>
                </div>

                <button onclick="runAIDiagnostic()" class="w-full bg-blue-600 py-4 rounded-2xl font-black uppercase text-[10px] tracking-[0.3em]">Run Diagnostic</button>
            </div>
        </div>

        <div class="lg:col-span-7">
            <div class="ai-border h-full">
                <div class="bg-[#0d1117] rounded-[38px] h-full p-10 flex flex-col">
                    <div class="flex justify-between mb-10">
                        <h2 class="text-4xl font-black italic tracking-tighter uppercase">Lung Stress <span class="text-blue-500">Score</span></h2>
                        <p id="final-score" class="text-6xl font-black text-white">--</p>
                    </div>
                    <div id="mentorship-msg" class="text-lg font-medium text-slate-300 leading-relaxed italic flex-grow">Awaiting Data Sync...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        let currentCondition = 'Healthy';
        let lifestyle = { smoke: false, drink: false };

        function setCondition(c) {
            currentCondition = c;
            document.querySelectorAll('.toggle-card').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + c).classList.add('active');
        }

        function toggleLifestyle(type) {
            lifestyle[type] = !lifestyle[type];
            document.getElementById('life-' + type).classList.toggle('active');
            document.getElementById('check-' + type).classList.toggle('bg-blue-500');
        }

        async function runAIDiagnostic() {
            const rawData = localStorage.getItem('currentAirData');
            if(!rawData) return alert("Please select a location on the map first.");
            const air = JSON.parse(rawData);
            
            const diagnosticData = {
                user_id: "user_" + Date.now(),
                air_data: {
                    main: { aqi: air.aqi },
                    components: { pm2_5: air.pm25, no2: air.no2, so2: air.so2, co: air.co }
                },
                condition: currentCondition,
                smoke: lifestyle.smoke,
                drink: lifestyle.drink
            };
            
            try {
                const response = await fetch('http://localhost:8001/api/diagnostic/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(diagnosticData)
                });
                const result = await response.json();
                document.getElementById('final-score').innerText = result.score;
                document.getElementById('mentorship-msg').innerText = `AI Analysis: ${result.recommendation}`;
            } catch (error) {
                let score = air.aqi * (currentCondition === 'Healthy' ? 1.0 : (currentCondition === 'Asthma' ? 2.5 : 4.0));
                if(lifestyle.smoke) score += 80;
                if(lifestyle.drink) score += 20;
                document.getElementById('final-score').innerText = Math.round(score);
                document.getElementById('mentorship-msg').innerText = `AI Analysis: For your ${currentCondition} profile, the environment is producing a stress load of ${Math.round(score)}. ` + (lifestyle.smoke ? "Smoking is significantly degrading your alveolar capacity." : "");
            }
        }
    </script>
</body>
</html>
